workflow:
  name: collab-to-aws-transfer
  version: "0.1.13"
  runtime:
    docker: null

  execution:
    memory: 4g
    cpu: 2

  input:
    project_code:
      type: string
    collab_study_id:
      type: string
    collab_dataset_id:
      type: string
    submitter_sample_id:
      type: string
    collab_sample_id:
      type: string
    icgc_sample_id:
      type: string
    submitter:
      type: string
    collab_analysis_id:
      type: string
    collab_experiment_id:  # null if it's analysis
      type: string
    collab_run_id:  # null if it's analysis
      type: string
    bundle_type: # experiement or analysis
      type: string
    bundle_id:   # either collabR or collabX ID
      type: string
    library_strategy:
      type: string
    collab_metadata_repo:
      type: string
    collab_metadata_file_name:
      type: string
    collab_metadata_object_id:  # this is the object_id obtained from ICGC service using bundle_id and ega_metadata_file_name as input
      type: string
    files:
      type: array
      items:
        type: object
        properties:
          collab_file_id:
            type: string
          file_name:
            type: string
          file_md5sum:
            type: string
          object_id:  # this is the object_id obtained from ICGC service using bundle_id and file_name as input
            type: string
          idx_file_name:
            type: string
          idx_object_id:
            type: string


  tasks:

    # prepare_metadata_xml:
    #   tool: prepare_metadata_xml
    #   input:
    #     collab_metadata_repo: collab_metadata_repo
    #     project_code: project_code
    #     bundle_id: bundle_id
    #     collab_study_id: collab_study_id
    #     collab_dataset_id: collab_dataset_id
    #     collab_sample_id: collab_sample_id
    #     collab_analysis_id: collab_analysis_id
    #     collab_expriment_id: collab_expriment_id
    #     collab_run_id: collab_run_id
    #     collab_metadata_file_name: collab_metadata_file_name
    #   depends_on: null
    #
    # xml_file_upload:
    #   tool: upload
    #   input:
    #     bundle_id: bundle_id
    #     object_id: collab_metadata_object_id  # this is the object_id obtained from ICGC service using bundle_id and collab_metadata_file_name as input
    #     file: xml_file@prepare_metadata_xml
    #     file_name: collab_metadata_file_name
    #     file_size: xml_file_size@prepare_metadata_xml
    #     file_md5sum: xml_file_md5sum@prepare_metadata_xml

    parallel_download:
      scatter:
        input:
          collab_file:
            with_items: files
            task_suffix: collab_file.collab_file_id
      tasks:
        download:
          tool: download
          input:
            project_code: project_code
            file_name: collab_file.file_name
            file_md5sum: collab_file.file_md5sum
            object_id: collab_file.object_id
          depends_on: null

        upload:
          tool: upload
          input:
            project_code: project_code
            file_name: file_name@download
            file: file@download
            file_md5sum: file_md5sum@download
            object_id: object_id@download
tools:
  prepare_metadata_xml:  # make a new XML cancatenate original collab XMLs: study, sample, analysis/(experiment and run)
    command: prepare_metadata_xml.py
    input:
      collab_metadata_repo:
        type: string
      project_code:
        type: string
      bundle_id:  # EGAR or EGAZ ID
        type: string
      collab_study_id:
        type: string
      collab_dataset_id:
        type: string
      collab_sample_id:
        type: string
      collab_analysis_id:
        type: string
      collab_expriment_id:
        type: string
      collab_run_id:
        type: string
      collab_metadata_file_name:
        type: string
    output:
      xml_file:
        type: string
        is_file: true
      xml_file_name:  # passing through from collab_metadata_file_name
        type: string
      xml_file_size:
        type: integer
      xml_file_md5sum:
        type: string
  download:
    command: download.py
    input:
      project_code:
        type: string
      file_name:
        type: string
      file_md5sum:
        type: string
      object_id:
        type: string
    output:
      file:  # new field
        type: string
        is_file: true
      file_name:  # passing through
        type: string
      file_md5sum:  # passing through
        type: string
      object_id:  # passing through
        type: string


  upload:
    command: upload.py
    input:
      bundle_id:
        type: string
      object_id:
        type: string
      file:
        type: string
        is_file: true
      file_name:
        type: string
      file_size:
        type: integer
      file_md5sum:
        type: string
      # the follow params are optional
      idx_object_id:
        type: string
      idx_file:
        type: string
        is_file: true
      idx_file_name:
        type: string
      idx_file_size:
        type: integer
      idx_file_md5sum:
        type: string
